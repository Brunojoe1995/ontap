---
sidebar: sidebar
permalink: snapmirror-active-sync/protect-task.html
keywords: SM-BC, snapmirror business continuity, consistency group, remote protection, 9.8, 9.9.1, destination
summary: Configuring protection for business continuity involves selecting LUNs on the ONTAP source cluster and adding them to a consistency group.
---

= Protect with SnapMirror active sync
:toclevels: 1
:hardbreaks:
:nofooter:
:icons: font
:linkattrs:
:imagesdir: ./media/

[.lead]
Configuring protection using SnapMirror active sync involves selecting LUNs on the ONTAP source cluster and adding them to a consistency group. 

.Before you begin

* You must have a SnapMirror synchronous license.
* You must be a cluster or storage VM administrator.
* All constituent volumes in a consistency group must be in a single storage VM (SVM).
** LUNs can reside on different volumes.
* The source and destination cluster cannot be the same.
* You cannot establish SnapMirror active sync consistency group relationships across ASA clusters and non-ASA clusters.
* The default IPspace is required by SnapMirror active sync for cluster peer relationships. Custom IPspace is not supported.
* The name of the consistency group must be unique.
* The volumes on the secondary (destination) cluster must be type DP.
* The primary and the secondary SVMs must be in a peered relationship.

.Steps 

You can configure a consistency group using the ONTAP CLI or System Manager. 

Beginning in ONTAP 9.10.1, ONTAP offers a consistency group endpoint and menu in System Manager, offering additional management utilities. If you are using ONTAP 9.10.1 or later, see link:../consistency-groups/configure-task.html[Configure a consistency group] then link:../consistency-groups/protect-task.html[configure protection] to create an SnapMirror active sync relationship. 

include::../_include/snapmirror-active-sync-name.adoc[]

[role="tabbed-block"]
====
.System Manager
--
. On the primary cluster, navigate to *Protection > Overview > Protect for Business Continuity > Protect LUNs*.
. Select the LUNs you want to protect and add them to a protection group.
. Select the destination cluster and SVM.
. *Initialize relationship* is selected by default. Click *Save* to begin protection.
. Go to *Dashboard > Performance* to verify IOPS activity for the LUNs.
. On the destination cluster, use System Manager to verify that the protection for business continuity relationship is in sync: *Protection > Relationships*.
--

.CLI
--
. Create a consistency group relationship from the destination cluster.
`destination::> snapmirror create -source-path _source-path_ -destination-path _destination-path_ -cg-item-mappings _volume-paths_ -policy _policy-name_
+
You can map up to 12 constituent volumes using the `cg-item-mappings` parameter on the `snapmirror create` command. 
+
The following example creates two consistency groups: `cg_src_ on the source with `vol1` and `vol2` and a mirrored destination consistency group, `cg_dst`.
+
`destination::> snapmirror create -source-path vs1_src:/cg/cg_src -destination-path vs1_dst:/cg/cg_dst -cg-item-mappings vol_src1:@vol_dst1,vol_src2:@vol_dst2 -policy AutomatedFailOver`
. From the destination cluster, initialize the consistency group.
+
`destination::>snapmirror initialize -destination-path _destination-consistency-group_`
. Confirm that the initialization operation completed successfully. The status should be `InSync`.
+
`snapmirror show`
. On each cluster, create an igroup so you can map LUNs to the initiator on the application host.
`lun igroup create -igroup _name_ -protocol _fcp|iscsi_ -ostype _os_ -initiator _initiator_name_`
+
. On each cluster, map LUNs to the igroup:
+
`lun map -path _path_name_ -igroup _igroup_name_`
. Verify the LUN mapping completed successfully with the `lun map` command. Then, you can discover the new LUNs on the application host. 

--
====

== Configure active/active protection 


=== Convert existing relationship to active/active 

.Before you begin 

* Both clusters must be running ONTAP 9.15.1 or later. 

// what is a uniform vs non-uniform config 

.Steps 
. Modify the SnapMirror policy from `AutomatedFailover` to `AutomatedFailoverDuplex`:
+
`snapmirror modify -destination-path _destination_path_ -policy AutomatedFailoverDuplex`
. Modifying the policy to `AutomatedFailoverDuplex` takes the relationship out of sync and trigger an resync operation. When the resync operation succeeds, birectional sync replication has been established. Confirm the relationship is `Insync`:
+
`snapmirror show -destination-path _destination_path_`
. If the existing hosts are local to cluster-1, add the host to the second cluster and establish connectivity with respective access to each cluster depending on the configuration. 

. Delete LUN maps on the Igroups associated with remote hosts. This is required to enable replication on the Igroup.

Note: Also ensure the Igroup does not contain maps for non-replicated LUNs (non SMBC)
+
`SiteB::> lun mapping delete -vserver vsB -igroup ig2 -path <>`
. Modify the initiator configuration for existing hosts to set the proximal path for initiators on the local cluster. Initiator replication effectively inverses the host proximity on the remote cluster.
+
`SiteA::> igroup initiator add-proximal-vserver -vserver _Svm_name_ -initiator _host_ -proximal-vserver _server_`

. Add a new Igroup config/Initiators for the new hosts and set the host proximity for host affinity to its local site. For uniform config, enable Igroup replication which will replicate the config and inverse the host locality on the remote cluster. For Non-uniform config, a new Igroup has to be created if one doesn't exist and Map existing LUNs to this Igroup.
+
**For a uniform configuration:**
``
SiteA::> igroup modify -vserver vsA -igroup ig1 -replication-peer vsB
SiteA::> igroup initiator add-proximal-vserver -vserver vsA -initiator host2 -proximal-vserver vsB
``
+
**For a non-uniform configuration:**
``
SiteB::> igroup create -vserver _svm_name_ -igroup _igroup_name_
SiteB::> igroup add -vserver _svm_name_ -igroup  _igroup_name_ -initiator _host_name_
SiteB::> lun mapping create -igroup  _igroup_name_ -path _path_name_
``
. Discover the paths on the hosts and verify the hosts have an Active/Optimized path to the storage LUN from the preferred cluster
. Deploy the VMSC application and distribute the VM workloads across clusters to achieve required Load balancing


// ontapdoc-883, 7 march 2023
//2Oct2020, BURT 1318823
//16nov2021, BURT 1436974 